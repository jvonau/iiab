# Base Server

- name: ...IS BEGINNING =====================================
  set_fact:
      STAGE: 3

- name: Configuring wondershaper
  include_tasks: roles/network/tasks/wondershaper.yml
  when: wondershaper_install
  tags: wondershaper, network

- name: Configuring named
  include_tasks: roles/network/tasks/named.yml
  tags: named, network, domain

- name: Supply resolvconf.conf
  template: dest=/etc/resolvconf.conf
            src=roles/network/templates/network/resolvconf.j2

- name: Restart resolvconf
  service: name=resolvconf state=restarted
  when: is_debuntu

- name: Configuring Squid
  include_tasks: roles/network/tasks/squid.yml
  when: squid_install
  tags: squid, network, domain

- name: Configuring dhcpd
  include_tasks: roles/network/tasks/dhcpd.yml
  tags: dhcpd, network, domain

- name: HTTPD
  include_role:
    name: httpd
  # has no "when: XXXXX_install" flag
  tags: base, httpd

- name: IIAB-ADMIN
  include_role:
    name: iiab-admin
  # has no "when: XXXXX_install" flag
  tags: base, iiab-admin

- name: MYSQL
  include_role:
    name: mysql
  # has no "when: XXXXX_install" flag
  tags: base, mysql

- name: Restart httpd
  service: name="{{ apache_service }}"
           state=restarted
  when: not installing

- name: Record STAGE 3 HAS COMPLETED ========================
  template:
        src: roles/1-prep/templates/iiab.stage.j2
        dest: /etc/iiab/iiab.env
        owner: root
        group: root
        mode: 0644
